[Update OpenCTI Marking Definition Lookup]
search = | inputlookup opencti_marking \
| append [ \
     search `opencti_index` sourcetype="opencti:marking-definition" (event="create" OR event="update") \
     | dedup id \
     | table _key id name type created definition_type sourcetype \
] \
| outputlookup append=true opencti_marking
description = Updates the opencti_marking lookup with new and updated marking definitions
schedule = */15 * * * *
enabled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */15 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[Update OpenCTI Indicators Lookup]
search = `opencti_index` sourcetype="opencti:indicator" (event="create" OR event="update") pattern_type="stix" \
    | eval modified_epoch = case( \
        match(modified, "^\d{4}-\d{2}-\d{2}T"), strptime(modified, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        match(updated_at, "^\d{4}-\d{2}-\d{2}T"), strptime(updated_at, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        match(created_at, "^\d{4}-\d{2}-\d{2}T"), strptime(created_at, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        true(), _time \
      ) \
    | eval _time = modified_epoch \
    | sort 0 id -_time \
    | dedup id \
    | rename markings{} AS markings object_marking_refs{} AS object_marking_refs labels{} AS labels \
             attack_patterns{} AS attack_patterns malware{} AS malware threat_actors{} AS threat_actors \
             vulnerabilities{} AS vulnerabilities \
    | lookup opencti_indicators id OUTPUT added_at AS existing_added_at \
    | eval added_at_epoch = case( \
        isnotnull(existing_added_at) AND match(existing_added_at, "^\d{4}-\d{2}-\d{2}T"), strptime(existing_added_at, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        true(), now() \
      ) \
    | eval added_at = strftime(added_at_epoch, "%Y-%m-%dT%H:%M:%S.%3NZ") \
    | eval _key = id \
    | table _key id created created_at created_by created_by_ref description detection indicator_types \
            input_name lang main_observable_type markings modified name object_marking_refs \
            pattern pattern_type revoked score spec_version type updated_at valid_from valid_until value \
            stream_id confidence labels attack_patterns malware threat_actors vulnerabilities added_at \
    | outputlookup append=t opencti_indicators
description = Incrementally upserts OpenCTI indicators into the opencti_indicators KV Store using the latest modified event per id.
schedule = */5 * * * *
enabled = 1
disabled = 0
is_scheduled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */5 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[Nightly Rebuild OpenCTI Indicators Lookup]
search = `opencti_index` sourcetype="opencti:indicator" (event="create" OR event="update") pattern_type="stix" \
    | eval modified_epoch = case( \
        match(modified, "^\d{4}-\d{2}-\d{2}T"), strptime(modified, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        match(updated_at, "^\d{4}-\d{2}-\d{2}T"), strptime(updated_at, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        match(created_at, "^\d{4}-\d{2}-\d{2}T"), strptime(created_at, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        true(), _time \
      ) \
    | eval _time = modified_epoch \
    | sort 0 id -_time \
    | dedup id \
    | rename markings{} AS markings object_marking_refs{} AS object_marking_refs labels{} AS labels \
             attack_patterns{} AS attack_patterns malware{} AS malware threat_actors{} AS threat_actors \
             vulnerabilities{} AS vulnerabilities indicator_types{} as indicator_types\
    | eval added_at_epoch = case( \
        match(created_at, "^\d{4}-\d{2}-\d{2}T"), strptime(created_at, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        true(), modified_epoch \
      ) \
    | eval added_at = strftime(added_at_epoch, "%Y-%m-%dT%H:%M:%S.%3NZ") \
    | eval _key = id \
    | table _key id created created_at created_by created_by_ref description detection indicator_types \
            input_name lang main_observable_type markings modified name object_marking_refs \
            pattern pattern_type revoked score spec_version type updated_at valid_from valid_until value \
            stream_id confidence labels attack_patterns malware threat_actors vulnerabilities added_at \
    | outputlookup opencti_indicators
description = Nightly full rebuild of the OpenCTI Indicators KV store. Ensures only the latest version per id remains and clears stale entries.
schedule = 30 2 * * *
enabled = 1
disabled = 0
is_scheduled = 1
dispatch.earliest_time = 0
dispatch.latest_time = now
cron_schedule = 30 2 * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[Update OpenCTI Reports Lookup]
search = | inputlookup opencti_reports \
| append [ \
    search `opencti_index` sourcetype="opencti:report" (event="create" OR event="update") \
    | eval added_at=now() \
    | eval added_at=strftime(added_at, "%Y-%m-%dT%H:%M:%S.%3N%z") \
    | rename markings{} AS markings object_marking_refs{} AS object_marking_refs labels{} AS labels report_types{} as report_types \
    | table _key, id, created, created_at, created_by, created_by_ref, description, report_types, input_name, markings, modified, name, score, confidence, spec_version, type, updated_at \
] \
| append [ \
     search `opencti_index` sourcetype="opencti:report" event="delete" \
     | eval delete_flag="true" \
     | table id, delete_flag \
] \
| stats values(*) AS * by id \
| where isnull(delete_flag) \
| fields - delete_flag \
| outputlookup opencti_reports
description = Updates the opencti_reports lookup with new and updated reportss, while flagging deleted ones.
schedule = 0 * * * *
enabled = 1
dispatch.earliest_time = -60m
dispatch.latest_time = now
cron_schedule = 0 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

#############################################
# OpenCTI â†’ ES Native Threat Intel Lookups  #
#############################################

[OpenCTI - ES IP Intelligence]
search = | inputlookup opencti_indicators \
    | where main_observable_type=="IPv4-Addr" OR main_observable_type=="IPv6-Addr" OR type=="ipv4-addr" OR type=="ipv6-addr" \
    | eval ip = value \
    | eval description = coalesce(name, description) \
    | eval weight = score \
    | eval source = "opencti" \
    | table ip description weight source \
    | dedup ip, source \
    | outputlookup append=t local_ip_intel
description = Populates the ES local_ip_intel lookup with IP indicators from OpenCTI for use in the ip_intel KV store.
schedule = */10 * * * *
enabled = 1
disabled = 0
is_scheduled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */10 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[OpenCTI - ES Domain Intelligence]
search = | inputlookup opencti_indicators \
    | where main_observable_type=="Domain-Name" OR type=="domain-name" \
    | eval domain = value \
    | eval description = coalesce(name, description) \
    | eval weight = score \
    | eval source = "opencti" \
    | table domain description weight source \
    | dedup domain, source \
    | outputlookup append=t local_domain_intel
description = Populates the ES local_domain_intel lookup with domain indicators from OpenCTI for use in the domain_intel KV store.
schedule = */10 * * * *
enabled = 1
disabled = 0
is_scheduled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */10 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[OpenCTI - ES URL Intelligence]
search = | inputlookup opencti_indicators \
    | where main_observable_type=="Url" OR type=="url" \
    | eval url = value \
    | eval description = coalesce(name, description) \
    | eval weight = score \
    | eval source = "opencti" \
    | table url description weight source \
    | dedup url, source \
    | outputlookup append=t local_http_intel
description = Populates the ES local_http_intel lookup with URL indicators from OpenCTI for use in the http/url intel collections.
schedule = */10 * * * *
enabled = 1
disabled = 0
is_scheduled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */10 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[OpenCTI - ES File Intelligence]
search = | inputlookup opencti_indicators \
    | where main_observable_type=="StixFile" OR type=="file" \
    | eval file_hash = value \
    | eval description = coalesce(name, description) \
    | eval weight = score \
    | eval source = "opencti" \
    | table file_hash description weight source \
    | dedup file_hash, source \
    | outputlookup append=t local_file_intel
description = Populates the ES local_file_intel lookup with file/hash indicators from OpenCTI for use in the file_intel KV store.
schedule = */10 * * * *
enabled = 1
disabled = 0
is_scheduled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */10 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[OpenCTI - ES Email Intelligence]
search = | inputlookup opencti_indicators \
    | where main_observable_type=="Email-Addr" OR type=="email-addr" \
    | eval email = value \
    | eval description = coalesce(name, description) \
    | eval weight = score \
    | eval source = "opencti" \
    | table email description weight source \
    | dedup email, source \
    | outputlookup append=t local_email_intel
description = Populates the ES local_email_intel lookup with email indicators from OpenCTI for use in the email_intel collections.
schedule = */10 * * * *
enabled = 1
disabled = 0
is_scheduled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */10 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0
