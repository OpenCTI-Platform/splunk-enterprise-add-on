[Update OpenCTI Marking Definition Lookup]
search = | inputlookup opencti_marking \
| append [ \
     search `opencti_index` sourcetype="opencti:marking-definition" (event="create" OR event="update") \
     | dedup id \
     | table _key id name type created definition_type sourcetype \
] \
| outputlookup append=true opencti_marking
description = Updates the opencti_marking lookup with new and updated marking definitions
schedule = */15 * * * *
enabled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */15 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[Update OpenCTI Indicators Lookup]
search = | inputlookup opencti_indicators \
| eval added_at_epoch = case( \
    isnum(added_at), added_at, \
    match(added_at, "^\d{4}-\d{2}-\d{2}T"), strptime(added_at, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
    true(), null() \
) \
| append [ \
    search `opencti_index` sourcetype="opencti:indicator" (event="create" OR event="update") pattern_type="stix" \
    | eval added_at_epoch = now() \
    | rename markings{} AS markings object_marking_refs{} AS object_marking_refs labels{} AS labels \
    | table _key id created created_at created_by created_by_ref description detection indicator_types \
            input_name lang main_observable_type markings modified name object_marking_refs \
            pattern pattern_type revoked score spec_version type updated_at valid_from valid_until value added_at_epoch \
] \
| append [ \
    search `opencti_index` sourcetype="opencti:indicator" event="delete" \
    | eval delete_flag="true" \
    | table id delete_flag \
] \
| stats \
    values(_key)                 AS _key \
    values(created)              AS created \
    values(created_at)           AS created_at \
    values(created_by)           AS created_by \
    values(created_by_ref)       AS created_by_ref \
    values(description)          AS description \
    values(detection)            AS detection \
    values(indicator_types)      AS indicator_types \
    values(input_name)           AS input_name \
    values(lang)                 AS lang \
    values(main_observable_type) AS main_observable_type \
    values(markings)             AS markings \
    values(modified)             AS modified \
    values(name)                 AS name \
    values(object_marking_refs)  AS object_marking_refs \
    values(pattern)              AS pattern \
    values(pattern_type)         AS pattern_type \
    values(revoked)              AS revoked \
    values(score)                AS score \
    values(spec_version)         AS spec_version \
    values(type)                 AS type \
    values(updated_at)           AS updated_at \
    values(valid_from)           AS valid_from \
    values(valid_until)          AS valid_until \
    values(value)                AS value \
    min(added_at_epoch)          AS added_at_epoch \
    values(delete_flag)          AS delete_flag \
    by id \
| where isnull(delete_flag) \
| eval added_at = strftime(added_at_epoch, "%Y-%m-%dT%H:%M:%S.%3NZ") \
| fields _key id name pattern revoked type value detection score main_observable_type \
        confidence labels created_by markings valid_from valid_until indicator_types \
        added_at input_name stream_id \
| outputlookup opencti_indicators
description = Updates the opencti_indicators lookup with new and updated indicators, while flagging deleted ones.
schedule = */5 * * * *
enabled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */5 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[Update OpenCTI Reports Lookup]
search = | inputlookup opencti_reports \
| append [ \
    search `opencti_index` sourcetype="opencti:report" (event="create" OR event="update") \
    | eval added_at=now() \
    | eval added_at=strftime(added_at, "%Y-%m-%dT%H:%M:%S.%3N%z") \
    |  rename markings{} AS markings object_marking_refs{} AS object_marking_refs labels{} AS labels report_types{} as report_types \
    | table _key, id, created, created_at, created_by, created_by_ref, description, report_types, input_name, markings, modified, name, score, spec_version, type, updated_at \
] \
| append [ \
     search `opencti_index` sourcetype="opencti:report" event="delete" \
     | eval delete_flag="true" \
     | table id, delete_flag \
] \
| stats values(*) AS * by id \
| where isnull(delete_flag) \
| fields - delete_flag \
| outputlookup opencti_reports
description = Updates the opencti_reports lookup with new and updated reportss, while flagging deleted ones.
schedule = 0 * * * *
enabled = 1
dispatch.earliest_time = -60m
dispatch.latest_time = now
cron_schedule = 0 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[Update OpenCTI Threat Intelligence]
search = | search `opencti_index` sourcetype="opencti:indicator" (event="create" OR event="update") \
         | eval threat_key=id \
         | eval threat_description=name \
         | eval threat_type=case( \
              type=="ipv4-addr", "ip_intel", \
              type=="domain-name", "domain_intel", \
              type=="url", "url_intel", \
              type=="file", "file_intel", \
              type=="email-addr", "email_intel", \
              1==1, "unknown" \
           ) \
         | eval threat_match_value=value \
         | eval threat_group=created_by \
         | eval threat_category=mvjoin(labels, ", ") \
         | eval threat_first_seen=created \
         | eval threat_last_seen=modified \
         | eval threat_confidence=confidence \
         | eval threat_weight=score \
         | table threat_key, threat_match_value, threat_type, threat_description, threat_group, threat_category, threat_first_seen, threat_last_seen, threat_confidence, threat_weight \
         | outputlookup append=T opencti_threatintel 
description = Converts OpenCTI indicators to Splunk ES Threat Intelligence format and stores them in the ES KV Store.
schedule = */5 * * * *
enabled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */5 * * * *
