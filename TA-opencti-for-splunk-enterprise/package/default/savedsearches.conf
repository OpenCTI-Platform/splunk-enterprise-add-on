[Update OpenCTI Marking Definition Lookup]
search = | inputlookup opencti_markings \
| append [ \
     search `opencti_index` sourcetype="opencti:marking-definition" (event="create" OR event="update") \
     | dedup id \
     | table _key id name type created definition_type sourcetype \
] \
| outputlookup append=true opencti_markings
description = Updates the opencti_markings lookup with new and updated marking definitions
schedule = */15 * * * *
enabled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */15 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[Update OpenCTI Indicators Lookup]
search = `opencti_index` sourcetype="opencti:indicator" (event="create" OR event="update") pattern_type="stix" \
    | eval modified_epoch = case( \
        match(modified, "^\d{4}-\d{2}-\d{2}T"), strptime(modified, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        match(updated_at, "^\d{4}-\d{2}-\d{2}T"), strptime(updated_at, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        match(created_at, "^\d{4}-\d{2}-\d{2}T"), strptime(created_at, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        true(), _time \
      ) \
    | eval _time = modified_epoch \
    | sort 0 id -_time \
    | dedup id \
    | rename markings{} AS markings object_marking_refs{} AS object_marking_refs labels{} AS labels \
             attack_patterns{} AS attack_patterns malware{} AS malware threat_actors{} AS threat_actors \
             vulnerabilities{} AS vulnerabilities \
    | lookup opencti_indicators id OUTPUT added_at AS existing_added_at \
    | eval added_at_epoch = case( \
        isnotnull(existing_added_at) AND match(existing_added_at, "^\d{4}-\d{2}-\d{2}T"), strptime(existing_added_at, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        true(), now() \
      ) \
    | eval added_at = strftime(added_at_epoch, "%Y-%m-%dT%H:%M:%S.%3NZ") \
    | eval _key = id \
    | table _key id created created_at created_by created_by_ref description detection indicator_types \
            input_name lang main_observable_type markings modified name object_marking_refs \
            pattern pattern_type revoked score spec_version type updated_at valid_from valid_until value \
            stream_id confidence labels attack_patterns malware threat_actors vulnerabilities added_at \
    | outputlookup append=t opencti_indicators
description = Incrementally upserts OpenCTI indicators into the opencti_indicators KV Store using the latest modified event per id.
schedule = */5 * * * *
enabled = 1
disabled = 0
is_scheduled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */5 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[Nightly Rebuild OpenCTI Indicators Lookup]
search = `opencti_index` sourcetype="opencti:indicator" (event="create" OR event="update") pattern_type="stix" \
    | eval modified_epoch = case( \
        match(modified, "^\d{4}-\d{2}-\d{2}T"), strptime(modified, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        match(updated_at, "^\d{4}-\d{2}-\d{2}T"), strptime(updated_at, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        match(created_at, "^\d{4}-\d{2}-\d{2}T"), strptime(created_at, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        true(), _time \
      ) \
    | eval _time = modified_epoch \
    | sort 0 id -_time \
    | dedup id \
    | rename markings{} AS markings object_marking_refs{} AS object_marking_refs labels{} AS labels \
             attack_patterns{} AS attack_patterns malware{} AS malware threat_actors{} AS threat_actors \
             vulnerabilities{} AS vulnerabilities indicator_types{} as indicator_types\
    | eval added_at_epoch = case( \
        match(created_at, "^\d{4}-\d{2}-\d{2}T"), strptime(created_at, "%Y-%m-%dT%H:%M:%S.%3NZ"), \
        true(), modified_epoch \
      ) \
    | eval added_at = strftime(added_at_epoch, "%Y-%m-%dT%H:%M:%S.%3NZ") \
    | eval _key = id \
    | table _key id created created_at created_by created_by_ref description detection indicator_types \
            input_name lang main_observable_type markings modified name object_marking_refs \
            pattern pattern_type revoked score spec_version type updated_at valid_from valid_until value \
            stream_id confidence labels attack_patterns malware threat_actors vulnerabilities added_at \
    | outputlookup opencti_indicators
description = Nightly full rebuild of the OpenCTI Indicators KV store. Ensures only the latest version per id remains and clears stale entries.
schedule = 30 2 * * *
enabled = 1
disabled = 0
is_scheduled = 1
dispatch.earliest_time = 0
dispatch.latest_time = now
cron_schedule = 30 2 * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[Update OpenCTI Reports Lookup]
search = | inputlookup opencti_reports \
| append [ \
    search `opencti_index` sourcetype="opencti:report" (event="create" OR event="update") \
    | eval added_at=now() \
    | eval added_at=strftime(added_at, "%Y-%m-%dT%H:%M:%S.%3N%z") \
    | rename markings{} AS markings object_marking_refs{} AS object_marking_refs labels{} AS labels report_types{} as report_types \
    | table _key, id, created, created_at, created_by, created_by_ref, description, report_types, input_name, markings, modified, name, score, confidence, spec_version, type, updated_at \
] \
| append [ \
     search `opencti_index` sourcetype="opencti:report" event="delete" \
     | eval delete_flag="true" \
     | table id, delete_flag \
] \
| stats values(*) AS * by id \
| where isnull(delete_flag) \
| fields - delete_flag \
| outputlookup opencti_reports
description = Updates the opencti_reports lookup with new and updated reports, while flagging deleted ones.
schedule = 0 * * * *
enabled = 1
dispatch.earliest_time = -60m
dispatch.latest_time = now
cron_schedule = 0 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[Update Enterprise Security Threat Intelligence]
search = | inputlookup opencti_indicators \
    | eval threat_key = id \
    | eval threat_match_value = value \
    | eval threat_type = case( \
        main_observable_type=="IPv4-Addr" OR type=="ipv4-addr", "ip_intel", \
        main_observable_type=="Domain-Name" OR type=="domain-name", "domain_intel", \
        main_observable_type=="Url" OR type=="url", "url_intel", \
        main_observable_type=="StixFile" OR type=="file", "file_intel", \
        main_observable_type=="Email-Addr" OR type=="email-addr", "email_intel", \
        1==1, "unknown" \
      ) \
    | eval threat_description = name \
    | eval threat_group = created_by \
    | eval threat_category = mvjoin(mvappend(labels, attack_patterns, malware, vulnerabilities), ", ") \
    | eval threat_first_seen = coalesce(valid_from, created, created_at) \
    | eval threat_last_seen  = coalesce(valid_until, modified, updated_at) \
    | eval threat_confidence = confidence \
    | eval threat_weight     = score \
    | table threat_key threat_match_value threat_type threat_description \
            threat_group threat_category threat_first_seen threat_last_seen \
            threat_confidence threat_weight \
    | outputlookup opencti_threatintel
description = Rebuilds the ES Threat Intelligence KV from the enriched opencti_indicators KV.
is_scheduled = 1
cron_schedule = */5 * * * *
disabled = 0
dispatch.earliest_time = 0
dispatch.latest_time = now
alert.suppress = 0
alert.track = 0
action.summary_index = 0
